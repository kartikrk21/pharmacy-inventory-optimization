<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Pharmacy Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>üìä Analytics & Forecasting</h1>
            <div class="header-controls">
                <a href="/dashboard" class="btn btn-primary">‚Üê Back to Dashboard</a>
            </div>
        </header>

        <!-- Medicine Selector -->
        <section class="panel">
            <h2>Select Medicine for Analysis</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <select id="medicineSelect" style="flex: 1; padding: 10px; border-radius: 8px;">
                    <option value="">-- Select Medicine --</option>
                </select>
                <button id="loadAnalyticsBtn" class="btn btn-success">Load Analytics</button>
            </div>
        </section>

        <!-- Forecast Chart -->
        <section class="panel">
            <h2>Demand Forecast (30 Days)</h2>
            <div id="forecastLoading" style="text-align: center; padding: 40px; display: none;">
                <div class="loading"></div>
                <p>Generating forecast...</p>
            </div>
            <canvas id="forecastChart" style="max-height: 400px;"></canvas>
            <div id="forecastStats" style="margin-top: 20px;"></div>
        </section>

        <!-- Historical Demand -->
        <section class="panel">
            <h2>Historical Demand (Last 90 Days)</h2>
            <canvas id="historicalChart" style="max-height: 300px;"></canvas>
        </section>

        <div class="content-grid">
            <!-- Model Performance -->
            <div class="panel">
                <h2>Model Performance</h2>
                <div id="modelPerformance"></div>
            </div>

            <!-- Forecast Metrics -->
            <div class="panel">
                <h2>Forecast Metrics</h2>
                <div id="forecastMetrics"></div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script>
        let forecastChart, historicalChart;

        // Load medicines on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadMedicines();
        });

        async function loadMedicines() {
            try {
                const response = await fetch('/api/medicines');
                const medicines = await response.json();
                
                const select = document.getElementById('medicineSelect');
                medicines.slice(0, 50).forEach(med => {
                    const option = document.createElement('option');
                    option.value = med.medicine_id;
                    option.textContent = `${med.medicine_name || med.medicine_id} (${med.category})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading medicines:', error);
            }
        }

        // Load analytics button
        document.getElementById('loadAnalyticsBtn').addEventListener('click', async function() {
            const medicineId = document.getElementById('medicineSelect').value;
            
            if (!medicineId) {
                alert('Please select a medicine');
                return;
            }

            // Show loading
            document.getElementById('forecastLoading').style.display = 'block';

            try {
                // Load forecast
                const response = await fetch(`/api/forecast/${medicineId}`);
                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    document.getElementById('forecastLoading').style.display = 'none';
                    return;
                }

                // Hide loading
                document.getElementById('forecastLoading').style.display = 'none';

                // Display forecast chart
                displayForecastChart(data);
                displayForecastStats(data);

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('forecastLoading').style.display = 'none';
                alert('Failed to load analytics');
            }
        });

        function displayForecastChart(data) {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            // Generate dates
            const dates = [];
            const today = new Date();
            for (let i = 1; i <= data.horizon_days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(date.toLocaleDateString());
            }

            if (forecastChart) {
                forecastChart.destroy();
            }

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Forecast',
                            data: data.forecast,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'Upper Bound (95%)',
                            data: data.upper_bound,
                            borderColor: '#ef4444',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Lower Bound (95%)',
                            data: data.lower_bound,
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Demand Forecast with 95% Confidence Interval'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        }
                    }
                }
            });
        }

        function displayForecastStats(data) {
            const avgForecast = data.forecast.reduce((a, b) => a + b, 0) / data.forecast.length;
            const avgUncertainty = data.uncertainty.reduce((a, b) => a + b, 0) / data.uncertainty.length;

            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <h4 style="margin-bottom: 5px; color: #6b7280;">Avg Daily Forecast</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #1f2937;">${avgForecast.toFixed(1)}</p>
                    </div>
                    <div style="padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <h4 style="margin-bottom: 5px; color: #6b7280;">Total 30-Day Demand</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #1f2937;">${data.forecast.reduce((a, b) => a + b, 0).toFixed(0)}</p>
                    </div>
                    <div style="padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <h4 style="margin-bottom: 5px; color: #6b7280;">Avg Uncertainty</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #1f2937;">¬±${avgUncertainty.toFixed(1)}</p>
                    </div>
                    <div style="padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <h4 style="margin-bottom: 5px; color: #6b7280;">Forecast Horizon</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #1f2937;">${data.horizon_days} days</p>
                    </div>
                </div>
            `;

            document.getElementById('forecastStats').innerHTML = html;
        }
    </script>
</body>
</html>

